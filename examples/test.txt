
#TIMESCALE 
horizon : 1 // hours 
step : 1 //hour

#NODE INVEST_PV
#PARAMETERS
c_pv = 1 //cost per unit of PV capacity in currency per watt
rate = 0.1 // interest rate
n = 1 // number of years
#VARIABLES
internal: ipv // internal variable of the total cost in currency
internal: p // intermediate variable for cost
output : ppv_max //max capacity of PV panels installed in Watt hour
output : c_p //investment cost in currency 
#CONSTRAINTS
ppv_max>=0;
ipv = c_pv * ppv_max;
p = ipv*rate*(1+n)**n/((1+rate)**n-1);
c_p = p/8760
#OBJECTIVES
min: c_p

#NODE PV
#PARAMETERS
avg_prod = {0,0,0,0,0,0,0,0,0,0.04,0.08,0.12,0.14,0.15,
       0.14,0.12,0.08,0.4,0,0,0,0,0,0,0,0,0} // average PV production per installed capacity (percentage)

#VARIABLES
input : ppv_max // max production in watt hour
output : ppv //the expected value of the PV power generation in watt

#CONSTRAINTS
ppv[t] = 0.5*ppv_max

#NODE INVEST_BAT
#PARAMETERS
c_unit = 1 //cost per unit of storage capacity installed in currency per watt
rate = 0.1 // interest rate
n = 1 // number of years
#VARIABLES
internal: ib //total cost of investment in currency 
internal: p //intermediate variable for cost
output: soCmax //max installed capacity in watt hour
output: c_b //investment cost in currency
#CONSTRAINTS
soCmax >=0;
ib = soCmax*c_unit;
p = ib*rate*(1+n)**n/((1+rate)**n-1);
c_b = p/8760

#OBJECTIVES
min: c_b


#NODE BATTERY
#PARAMETERS

p = 1 // proportion of battery capacity

#VARIABLES
input: soCmax // max installed capacity in watt hour
internal: soC //state of charge of the battery in watt hour
internal: pb //intermediate variable for limiting battery capacity
output: a //chosen action in watt hour
output: pbt  //actual charging power in watt
#CONSTRAINTS
pb = p*soCmax; // charge limit
soC[0]=soCmax/2;
soC[t] >= 0;
soC[t] <= soCmax;
pb>=0;
a[t] >= -pb;
a[t] <= pb;
soC[t+1] = soC[t]+a[t] ;
pbt[t] = soCmax - soC[t];

#NODE DEMAND
#PARAMETERS
demand = {6.9,6.4,6.1,5.9,5.7,5.4,4.8, 4.5, 4.6, 
4.6,4.7,4.9,5.1,5.3,5.4,5.4,5.4,5.8, 8.4,10.6,11.0,10.5,9.2,7.8}
#VARIABLES
output:pc //consumption in watt 
#CONSTRAINTS
pc[t] = demand[mod(t,24)]

#NODE OPERATION_COST
#PARAMETERS
pi_shed = 10 //  in curr/watt

#VARIABLES
input: pbt //in watt
input: ppv //in watt
input: c_p //in curr
input: c_b //in curr
input: pc //in watt
internal: cfix  //currency
internal: cshed //currency
internal: pcurtail
output: r //reward
#CONSTRAINTS
ppv = 0.5;
pcurtail[t] = ppv[t] - pbt[t] - pc[t];
cshed[t]= - pcurtail[t]*pi_shed;
r[t]= c_p + c_b + cshed[t];
#OBJECTIVES
min: r

#LINKS 
INVEST_PV.ppv_max = PV.ppv_max
INVEST_BAT.soCmax = BATTERY.soCmax

DEMAND.pc = OPERATION_COST.pc
BATTERY.pbt = OPERATION_COST.pbt
INVEST_PV.c_p = OPERATION_COST.c_p
INVEST_BAT.c_b = OPERATION_COST.c_b